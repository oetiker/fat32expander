name: Rust Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt

    - name: Install test dependencies
      run: |
        echo "::group::Installing dependencies"
        sudo apt-get update && sudo apt-get install -y dosfstools mtools qemu-system-x86 musl-tools
        echo "::endgroup::"

    - name: Install musl target for static builds
      run: rustup target add x86_64-unknown-linux-musl

    - name: Check formatting
      run: |
        echo "::group::Checking code formatting"
        cargo fmt -- --check
        echo "::endgroup::"

    - name: Run clippy
      run: |
        echo "::group::Running clippy lints"
        cargo clippy -- -D warnings
        echo "::endgroup::"

    - name: Build
      run: |
        echo "::group::Building project"
        cargo build --release
        echo "::endgroup::"

    - name: Run unit tests
      run: |
        echo "::group::Running unit tests"
        cargo test --lib 2>&1 | tee unit-test-results.txt
        UNIT_EXIT=${PIPESTATUS[0]}

        # Parse results from standard test output
        if grep -q "test result:" unit-test-results.txt; then
          RESULTS=$(grep "test result:" unit-test-results.txt | tail -1)
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "$RESULTS" >> $GITHUB_STEP_SUMMARY
        fi

        echo "::endgroup::"
        exit $UNIT_EXIT

    - name: Run integration tests
      run: |
        echo "::group::Running integration tests"
        cargo test --test integration_test -- --ignored 2>&1 | tee integration-test-results.txt
        INTEGRATION_EXIT=${PIPESTATUS[0]}

        # Parse results from standard test output
        if grep -q "test result:" integration-test-results.txt; then
          RESULTS=$(grep "test result:" integration-test-results.txt | tail -1)
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "$RESULTS" >> $GITHUB_STEP_SUMMARY
        fi

        echo "::endgroup::"
        exit $INTEGRATION_EXIT

    - name: Run test script
      run: |
        echo "::group::Running test-resize.sh"
        ./scripts/test-resize.sh
        echo "## Test Script" >> $GITHUB_STEP_SUMMARY
        echo "✅ test-resize.sh passed" >> $GITHUB_STEP_SUMMARY
        echo "::endgroup::"

    - name: Setup Alpine for QEMU tests
      run: |
        echo "::group::Setting up Alpine Linux for QEMU"
        ./scripts/qemu/setup-alpine.sh setup
        echo "::endgroup::"

    - name: Build static binary for QEMU tests
      run: |
        echo "::group::Building static musl binary"
        cargo build --release --target x86_64-unknown-linux-musl
        echo "::endgroup::"

    - name: Run QEMU tests
      run: |
        echo "::group::Running QEMU-based tests"
        ./scripts/qemu/test-qemu.sh 2>&1 | tee qemu-test-results.txt
        QEMU_EXIT=${PIPESTATUS[0]}

        # Add summary
        echo "## QEMU Test Results" >> $GITHUB_STEP_SUMMARY
        if [ $QEMU_EXIT -eq 0 ]; then
          PASSED=$(grep -c "PASSED" qemu-test-results.txt || echo "0")
          echo "✅ All QEMU tests passed ($PASSED tests)" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ QEMU tests failed" >> $GITHUB_STEP_SUMMARY
          grep -E "(FAILED|ERROR)" qemu-test-results.txt >> $GITHUB_STEP_SUMMARY || true
        fi

        echo "::endgroup::"
        exit $QEMU_EXIT

