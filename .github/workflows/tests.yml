name: Rust Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt

    - name: Install test dependencies
      run: |
        echo "::group::Installing dependencies"
        sudo apt-get update && sudo apt-get install -y dosfstools mtools
        echo "::endgroup::"

    - name: Check formatting
      run: |
        echo "::group::Checking code formatting"
        cargo fmt -- --check
        echo "::endgroup::"

    - name: Run clippy
      run: |
        echo "::group::Running clippy lints"
        cargo clippy -- -D warnings
        echo "::endgroup::"

    - name: Build
      run: |
        echo "::group::Building project"
        cargo build --release
        echo "::endgroup::"

    - name: Run unit tests
      run: |
        echo "::group::Running unit tests"
        cargo test --lib 2>&1 | tee unit-test-results.txt
        UNIT_EXIT=${PIPESTATUS[0]}

        # Parse results from standard test output
        if grep -q "test result:" unit-test-results.txt; then
          RESULTS=$(grep "test result:" unit-test-results.txt | tail -1)
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "$RESULTS" >> $GITHUB_STEP_SUMMARY
        fi

        echo "::endgroup::"
        exit $UNIT_EXIT

    - name: Run integration tests
      run: |
        echo "::group::Running integration tests"
        cargo test --test integration_test -- --ignored 2>&1 | tee integration-test-results.txt
        INTEGRATION_EXIT=${PIPESTATUS[0]}

        # Parse results from standard test output
        if grep -q "test result:" integration-test-results.txt; then
          RESULTS=$(grep "test result:" integration-test-results.txt | tail -1)
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "$RESULTS" >> $GITHUB_STEP_SUMMARY
        fi

        echo "::endgroup::"
        exit $INTEGRATION_EXIT

    - name: Run test script
      run: |
        echo "::group::Running test-resize.sh"
        ./scripts/test-resize.sh
        echo "## Test Script" >> $GITHUB_STEP_SUMMARY
        echo "âœ… test-resize.sh passed" >> $GITHUB_STEP_SUMMARY
        echo "::endgroup::"

